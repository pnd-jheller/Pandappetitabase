<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pandappetitabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #faf9f6;
      --surface: #ffffff;
      --border: #e8e4dd;
      --accent: #c4622d;
      --accent-light: #f5ebe3;
      --text: #1a1a1a;
      --muted: #888;
      --radius: 10px;
      --nav-w: 200px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* NAV */
    nav {
      width: var(--nav-w);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 24px 0;
      flex-shrink: 0;
    }
    .nav-logo {
      padding: 0 20px 24px;
      font-size: 17px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.3px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .nav-logo span { font-weight: 400; color: var(--muted); font-size: 12px; display: block; margin-top: 2px; }
    nav button {
      background: none;
      border: none;
      text-align: left;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      color: var(--muted);
      border-radius: 0;
      transition: all 0.15s;
      font-weight: 500;
    }
    nav button:hover { color: var(--text); background: var(--bg); }
    nav button.active { color: var(--accent); background: var(--accent-light); font-weight: 600; }

    /* MAIN */
    main {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .section { display: none; }
    .section.active { display: block; }

    h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
    .subtitle { color: var(--muted); font-size: 13px; margin-bottom: 24px; }

    /* CARDS */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .card h3 { font-size: 15px; font-weight: 600; }
    .tag {
      background: var(--accent-light);
      color: var(--accent);
      border-radius: 20px;
      padding: 2px 10px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .card p { font-size: 13px; color: var(--muted); line-height: 1.6; }

    /* FORMS */
    .form-row { margin-bottom: 14px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    input[type=text], input[type=number], textarea, select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 9px 12px;
      font-size: 14px;
      font-family: inherit;
      background: var(--bg);
      color: var(--text);
      outline: none;
      transition: border 0.15s;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: #fff; }
    textarea { resize: vertical; min-height: 90px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 18px;
      border-radius: 7px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #b0571f; }
    .btn-ghost { background: none; border: 1px solid var(--border); color: var(--muted); }
    .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .btn-danger { background: none; border: none; color: #ccc; font-size: 16px; cursor: pointer; padding: 2px 6px; }
    .btn-danger:hover { color: #e55; }

    /* PANEL / DRAWER */
    .panel-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      z-index: 100;
    }
    .panel-overlay.open { display: flex; justify-content: flex-end; }
    .panel {
      width: 480px;
      max-width: 95vw;
      background: var(--surface);
      height: 100%;
      overflow-y: auto;
      padding: 28px;
      box-shadow: -4px 0 24px rgba(0,0,0,0.08);
    }
    .panel h2 { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
    .panel-actions { display: flex; gap: 10px; margin-top: 20px; }

    /* GRID */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    /* HYDRATION */
    .hydration-box {
      background: var(--accent-light);
      border: 1px solid #e8c9b3;
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .hydration-pct { font-size: 38px; font-weight: 800; color: var(--accent); line-height: 1; }
    .hydration-label { font-size: 12px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .hydration-detail { font-size: 11px; color: #b07050; margin-top: 3px; }

    /* FLOUR ROWS */
    .flour-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .flour-row input { flex: 1; }
    .flour-row input:last-of-type { flex: 0 0 100px; }

    /* MENU PLANNER */
    .month-nav { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
    .month-nav h2 { font-size: 18px; font-weight: 700; min-width: 160px; text-align: center; }
    .calendar { display: flex; flex-direction: column; gap: 0; }
    .week-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 6px; }
    .day-cell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      min-height: 90px;
      cursor: pointer;
      transition: border 0.15s;
      position: relative;
    }
    .day-cell:hover { border-color: var(--accent); }
    .day-cell.inactive { opacity: 0.3; cursor: default; pointer-events: none; }
    .day-cell.inactive:hover { border-color: var(--border); }
    .day-num { font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 6px; }
    .day-name { font-size: 10px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
    .meal-preview { font-size: 10px; color: var(--text); line-height: 1.4; }
    .meal-label { font-size: 9px; font-weight: 700; color: var(--muted); text-transform: uppercase; }
    .week-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 4px; }
    .week-header div { font-size: 10px; font-weight: 600; color: var(--muted); text-align: center; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px; }

    /* HOW MUCH */
    .hm-table { width: 100%; border-collapse: collapse; }
    .hm-table th { text-align: left; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; border-bottom: 1px solid var(--border); }
    .hm-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    .hm-table tr:last-child td { border-bottom: none; }
    .hm-table tr:hover td { background: var(--bg); }

    /* UTIL */
    .empty { text-align: center; color: var(--muted); font-size: 14px; padding: 48px; }
    .row-actions { display: flex; gap: 8px; }
    .search-bar { display: flex; gap: 10px; margin-bottom: 16px; }
    .search-bar input { flex: 1; }
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a1a1a;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }

    .bread-card-meta { display: flex; gap: 16px; margin-top: 6px; flex-wrap: wrap; }
    .bread-card-meta span { font-size: 12px; color: var(--muted); }
    .bread-card-meta strong { color: var(--text); }
    .hydration-badge {
      background: var(--accent);
      color: #fff;
      border-radius: 20px;
      padding: 2px 10px;
      font-size: 11px;
      font-weight: 700;
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-logo">Pandappetitabase <span>Pandata Kitchen</span></div>
  <button class="active" onclick="showSection('recipes')">Recipes</button>
  <button onclick="showSection('bread')">Bread</button>
  <button onclick="showSection('howmuch')">How Much?</button>
  <button onclick="showSection('menu')">Menu Planner</button>
</nav>

<main>

  <!-- RECIPES -->
  <div class="section active" id="section-recipes">
    <h1>Recipes</h1>
    <p class="subtitle">Archived recipes, organised by dish type.</p>
    <div class="search-bar">
      <input type="text" id="recipe-search" placeholder="Search recipes..." oninput="filterRecipes()" />
      <select id="recipe-filter-cat" onchange="filterRecipes()">
        <option value="">All categories</option>
      </select>
      <button class="btn btn-primary" onclick="openRecipePanel()">+ Add Recipe</button>
    </div>
    <div id="recipe-list"><div class="empty">No recipes yet. Add your first one!</div></div>
  </div>

  <!-- BREAD -->
  <div class="section" id="section-bread">
    <h1>Bread</h1>
    <p class="subtitle">Sourdough bake log with hydration calculator.</p>
    <div style="text-align:right;margin-bottom:16px">
      <button class="btn btn-primary" onclick="openBreadPanel()">+ Add Bake</button>
    </div>
    <div id="bread-list"><div class="empty">No bakes logged yet.</div></div>
  </div>

  <!-- HOW MUCH -->
  <div class="section" id="section-howmuch">
    <h1>How Much?</h1>
    <p class="subtitle">Quick reference for quantities and portions.</p>
    <div style="text-align:right;margin-bottom:16px">
      <button class="btn btn-primary" onclick="openHMPanel()">+ Add Entry</button>
    </div>
    <div class="card" style="padding:0;overflow:hidden">
      <table class="hm-table">
        <thead><tr><th>Item</th><th>Quantity / Note</th><th></th></tr></thead>
        <tbody id="hm-body"><tr><td colspan="3" class="empty">Nothing here yet.</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- MENU PLANNER -->
  <div class="section" id="section-menu">
    <h1>Menu Planner</h1>
    <p class="subtitle">Breakfast &amp; lunch — Monday, Tuesday, Thursday.</p>
    <div class="month-nav">
      <button class="btn btn-ghost" onclick="changeMonth(-1)">&#8592;</button>
      <h2 id="month-label"></h2>
      <button class="btn btn-ghost" onclick="changeMonth(1)">&#8594;</button>
    </div>
    <div class="week-header">
      <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
    </div>
    <div id="calendar-grid" class="calendar"></div>
  </div>

</main>

<!-- RECIPE PANEL -->
<div class="panel-overlay" id="recipe-panel" onclick="closePanelIfOverlay(event,'recipe-panel')">
  <div class="panel">
    <h2 id="recipe-panel-title">Add Recipe</h2>
    <input type="hidden" id="recipe-id" />
    <div class="form-row">
      <label>Title</label>
      <input type="text" id="recipe-title" placeholder="e.g. Miso Ramen" />
    </div>
    <div class="form-row">
      <label>Category</label>
      <div style="display:flex;gap:8px">
        <select id="recipe-cat-select" style="flex:1"></select>
        <input type="text" id="recipe-cat-new" placeholder="Or new category..." style="flex:1" />
      </div>
    </div>
    <div class="form-row">
      <label>Ingredients</label>
      <textarea id="recipe-ingredients" placeholder="List your ingredients here..."></textarea>
    </div>
    <div class="form-row">
      <label>Method</label>
      <textarea id="recipe-method" placeholder="Steps, notes, stream of consciousness — whatever works..." style="min-height:140px"></textarea>
    </div>
    <div class="panel-actions">
      <button class="btn btn-primary" onclick="saveRecipe()">Save Recipe</button>
      <button class="btn btn-ghost" onclick="closePanel('recipe-panel')">Cancel</button>
      <button class="btn btn-danger" id="recipe-delete-btn" onclick="deleteRecipe()" style="margin-left:auto;display:none">Delete</button>
    </div>
  </div>
</div>

<!-- BREAD PANEL -->
<div class="panel-overlay" id="bread-panel" onclick="closePanelIfOverlay(event,'bread-panel')">
  <div class="panel">
    <h2 id="bread-panel-title">Log a Bake</h2>
    <input type="hidden" id="bread-id" />
    <div class="form-row">
      <label>Name / Label</label>
      <input type="text" id="bread-name" placeholder="e.g. Country loaf, 26 Feb" />
    </div>
    <div class="form-row">
      <label>Flours</label>
      <div id="flour-rows"></div>
      <button class="btn btn-ghost" style="margin-top:6px;font-size:12px" onclick="addFlourRow()">+ Add flour</button>
    </div>
    <div class="grid-2">
      <div class="form-row">
        <label>Water (g)</label>
        <input type="number" id="bread-water" placeholder="350" oninput="calcHydration()" />
      </div>
      <div class="form-row">
        <label>Starter / Levain (g)</label>
        <input type="number" id="bread-starter" placeholder="100" oninput="calcHydration()" />
      </div>
    </div>
    <div class="hydration-box" id="hydration-box" style="display:none">
      <div>
        <div class="hydration-pct" id="hydration-pct">--%</div>
        <div class="hydration-label">Total Hydration</div>
        <div class="hydration-detail" id="hydration-detail"></div>
      </div>
    </div>
    <div class="form-row" style="margin-top:16px">
      <label>Notes</label>
      <textarea id="bread-notes" placeholder="Crumb, crust, anything to remember..."></textarea>
    </div>
    <div class="panel-actions">
      <button class="btn btn-primary" onclick="saveBread()">Save Bake</button>
      <button class="btn btn-ghost" onclick="closePanel('bread-panel')">Cancel</button>
      <button class="btn btn-danger" id="bread-delete-btn" onclick="deleteBread()" style="margin-left:auto;display:none">Delete</button>
    </div>
  </div>
</div>

<!-- HOW MUCH PANEL -->
<div class="panel-overlay" id="hm-panel" onclick="closePanelIfOverlay(event,'hm-panel')">
  <div class="panel">
    <h2>Add Entry</h2>
    <input type="hidden" id="hm-id" />
    <div class="form-row">
      <label>Item</label>
      <input type="text" id="hm-item" placeholder="e.g. Rice" />
    </div>
    <div class="form-row">
      <label>Quantity / Note</label>
      <input type="text" id="hm-qty" placeholder="e.g. 80g per person" />
    </div>
    <div class="panel-actions">
      <button class="btn btn-primary" onclick="saveHM()">Save</button>
      <button class="btn btn-ghost" onclick="closePanel('hm-panel')">Cancel</button>
      <button class="btn btn-danger" id="hm-delete-btn" onclick="deleteHM()" style="margin-left:auto;display:none">Delete</button>
    </div>
  </div>
</div>

<!-- MENU PANEL -->
<div class="panel-overlay" id="menu-panel" onclick="closePanelIfOverlay(event,'menu-panel')">
  <div class="panel">
    <h2 id="menu-panel-title">Edit Menu</h2>
    <input type="hidden" id="menu-date" />
    <div class="form-row">
      <label>Breakfast</label>
      <textarea id="menu-breakfast" placeholder="What's for breakfast?" style="min-height:80px"></textarea>
    </div>
    <div class="form-row">
      <label>Lunch</label>
      <textarea id="menu-lunch" placeholder="What's for lunch?" style="min-height:80px"></textarea>
    </div>
    <div class="panel-actions">
      <button class="btn btn-primary" onclick="saveMenu()">Save</button>
      <button class="btn btn-ghost" onclick="closePanel('menu-panel')">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://zizakjhoqznpdorhpacp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppemFramhvcXpucGRvcmhwYWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTgyODMsImV4cCI6MjA4NzY3NDI4M30.Wy4hjP6htzpRqoz-qWzbOMNJCpEd5pj3RS2CM2ul9rA';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ─── NAV ────────────────────────────────────────────────────────────────────
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
  event.target.classList.add('active');
  if (id === 'recipes') loadRecipes();
  if (id === 'bread') loadBreads();
  if (id === 'howmuch') loadHM();
  if (id === 'menu') renderCalendar();
}

// ─── TOAST ──────────────────────────────────────────────────────────────────
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ─── PANELS ─────────────────────────────────────────────────────────────────
function closePanel(id) { document.getElementById(id).classList.remove('open'); }
function closePanelIfOverlay(e, id) { if (e.target === e.currentTarget) closePanel(id); }

// ─── RECIPES ────────────────────────────────────────────────────────────────
let allRecipes = [];
let allCategories = [];

async function loadRecipes() {
  const { data: cats } = await sb.from('recipe_categories').select('*').order('name');
  allCategories = cats || [];
  const { data } = await sb.from('recipes').select('*, recipe_categories(name)').order('created_at', { ascending: false });
  allRecipes = data || [];
  populateCatFilters();
  renderRecipes(allRecipes);
}

function populateCatFilters() {
  const sel = document.getElementById('recipe-filter-cat');
  const panelSel = document.getElementById('recipe-cat-select');
  sel.innerHTML = '<option value="">All categories</option>' + allCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  panelSel.innerHTML = '<option value="">— Select category —</option>' + allCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function renderRecipes(recipes) {
  const el = document.getElementById('recipe-list');
  if (!recipes.length) { el.innerHTML = '<div class="empty">No recipes found.</div>'; return; }
  el.innerHTML = recipes.map(r => `
    <div class="card" style="cursor:pointer" onclick="openRecipePanel(${JSON.stringify(r).replace(/"/g,'&quot;')})">
      <div class="card-header">
        <h3>${r.title}</h3>
        ${r.recipe_categories ? `<span class="tag">${r.recipe_categories.name}</span>` : ''}
      </div>
      ${r.ingredients ? `<p style="margin-bottom:4px"><strong style="font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)">Ingredients</strong><br>${r.ingredients.substring(0,120)}${r.ingredients.length>120?'…':''}</p>` : ''}
    </div>
  `).join('');
}

function filterRecipes() {
  const q = document.getElementById('recipe-search').value.toLowerCase();
  const cat = document.getElementById('recipe-filter-cat').value;
  let f = allRecipes;
  if (q) f = f.filter(r => r.title.toLowerCase().includes(q) || (r.ingredients||'').toLowerCase().includes(q) || (r.method||'').toLowerCase().includes(q));
  if (cat) f = f.filter(r => r.category_id === cat);
  renderRecipes(f);
}

function openRecipePanel(recipe) {
  document.getElementById('recipe-panel-title').textContent = recipe ? 'Edit Recipe' : 'Add Recipe';
  document.getElementById('recipe-id').value = recipe ? recipe.id : '';
  document.getElementById('recipe-title').value = recipe ? recipe.title : '';
  document.getElementById('recipe-cat-select').value = recipe && recipe.category_id ? recipe.category_id : '';
  document.getElementById('recipe-cat-new').value = '';
  document.getElementById('recipe-ingredients').value = recipe ? (recipe.ingredients||'') : '';
  document.getElementById('recipe-method').value = recipe ? (recipe.method||'') : '';
  document.getElementById('recipe-delete-btn').style.display = recipe ? 'inline-flex' : 'none';
  populateCatFilters();
  if (recipe && recipe.category_id) document.getElementById('recipe-cat-select').value = recipe.category_id;
  document.getElementById('recipe-panel').classList.add('open');
}

async function saveRecipe() {
  const title = document.getElementById('recipe-title').value.trim();
  if (!title) { toast('Please enter a title'); return; }

  let catId = document.getElementById('recipe-cat-select').value;
  const newCat = document.getElementById('recipe-cat-new').value.trim();
  if (newCat) {
    const { data } = await sb.from('recipe_categories').insert({ name: newCat }).select().single();
    catId = data.id;
  }

  const payload = {
    title,
    category_id: catId || null,
    ingredients: document.getElementById('recipe-ingredients').value.trim(),
    method: document.getElementById('recipe-method').value.trim(),
  };

  const id = document.getElementById('recipe-id').value;
  if (id) {
    await sb.from('recipes').update(payload).eq('id', id);
  } else {
    await sb.from('recipes').insert(payload);
  }
  closePanel('recipe-panel');
  toast('Recipe saved!');
  loadRecipes();
}

async function deleteRecipe() {
  if (!confirm('Delete this recipe?')) return;
  const id = document.getElementById('recipe-id').value;
  await sb.from('recipes').delete().eq('id', id);
  closePanel('recipe-panel');
  toast('Recipe deleted.');
  loadRecipes();
}

// ─── BREAD ──────────────────────────────────────────────────────────────────
let allBreads = [];
let flourRowCount = 0;

async function loadBreads() {
  const { data } = await sb.from('breads').select('*, bread_flours(*)').order('created_at', { ascending: false });
  allBreads = data || [];
  renderBreads();
}

function renderBreads() {
  const el = document.getElementById('bread-list');
  if (!allBreads.length) { el.innerHTML = '<div class="empty">No bakes logged yet.</div>'; return; }
  el.innerHTML = allBreads.map(b => {
    const totalFlour = (b.bread_flours||[]).reduce((s,f) => s + f.grams, 0) + (b.starter_grams||0)/2;
    const totalWater = (b.water_grams||0) + (b.starter_grams||0)/2;
    const hyd = totalFlour > 0 ? Math.round(totalWater / totalFlour * 100) : null;
    const flourList = (b.bread_flours||[]).map(f => `${f.flour_name} ${f.grams}g`).join(', ');
    return `
      <div class="card" style="cursor:pointer" onclick="openBreadPanel(${JSON.stringify(b).replace(/"/g,'&quot;')})">
        <div class="card-header">
          <h3>${b.name}</h3>
          ${hyd !== null ? `<span class="hydration-badge">${hyd}% hydration</span>` : ''}
        </div>
        <div class="bread-card-meta">
          ${flourList ? `<span><strong>Flours:</strong> ${flourList}</span>` : ''}
          ${b.water_grams ? `<span><strong>Water:</strong> ${b.water_grams}g</span>` : ''}
          ${b.starter_grams ? `<span><strong>Starter:</strong> ${b.starter_grams}g</span>` : ''}
        </div>
        ${b.notes ? `<p style="margin-top:8px">${b.notes.substring(0,150)}${b.notes.length>150?'…':''}</p>` : ''}
      </div>
    `;
  }).join('');
}

function addFlourRow(name='', grams='') {
  flourRowCount++;
  const id = 'flour-' + flourRowCount;
  const div = document.createElement('div');
  div.className = 'flour-row';
  div.id = id;
  div.innerHTML = `
    <input type="text" placeholder="Flour type (e.g. bread flour)" value="${name}" oninput="calcHydration()" class="flour-name"/>
    <input type="number" placeholder="grams" value="${grams}" oninput="calcHydration()" class="flour-grams" style="flex:0 0 90px"/>
    <button class="btn-danger" onclick="document.getElementById('${id}').remove();calcHydration()">×</button>
  `;
  document.getElementById('flour-rows').appendChild(div);
}

function calcHydration() {
  const water = parseFloat(document.getElementById('bread-water').value) || 0;
  const starter = parseFloat(document.getElementById('bread-starter').value) || 0;
  const flourRows = document.querySelectorAll('.flour-grams');
  const totalFlour = Array.from(flourRows).reduce((s,i) => s + (parseFloat(i.value)||0), 0) + starter/2;
  const totalWater = water + starter/2;
  const box = document.getElementById('hydration-box');
  if (totalFlour > 0 && totalWater > 0) {
    const pct = Math.round(totalWater / totalFlour * 100);
    document.getElementById('hydration-pct').textContent = pct + '%';
    document.getElementById('hydration-detail').textContent = `${Math.round(totalWater)}g water ÷ ${Math.round(totalFlour)}g flour`;
    box.style.display = 'flex';
  } else {
    box.style.display = 'none';
  }
}

function openBreadPanel(bread) {
  document.getElementById('bread-panel-title').textContent = bread ? 'Edit Bake' : 'Log a Bake';
  document.getElementById('bread-id').value = bread ? bread.id : '';
  document.getElementById('bread-name').value = bread ? bread.name : '';
  document.getElementById('bread-water').value = bread ? (bread.water_grams||'') : '';
  document.getElementById('bread-starter').value = bread ? (bread.starter_grams||'') : '';
  document.getElementById('bread-notes').value = bread ? (bread.notes||'') : '';
  document.getElementById('flour-rows').innerHTML = '';
  flourRowCount = 0;
  if (bread && bread.bread_flours && bread.bread_flours.length) {
    bread.bread_flours.forEach(f => addFlourRow(f.flour_name, f.grams));
  } else {
    addFlourRow();
  }
  document.getElementById('bread-delete-btn').style.display = bread ? 'inline-flex' : 'none';
  document.getElementById('hydration-box').style.display = 'none';
  calcHydration();
  document.getElementById('bread-panel').classList.add('open');
}

async function saveBread() {
  const name = document.getElementById('bread-name').value.trim();
  if (!name) { toast('Please enter a name'); return; }
  const payload = {
    name,
    water_grams: parseFloat(document.getElementById('bread-water').value)||null,
    starter_grams: parseFloat(document.getElementById('bread-starter').value)||null,
    notes: document.getElementById('bread-notes').value.trim(),
  };
  const flours = Array.from(document.querySelectorAll('.flour-row')).map(row => ({
    flour_name: row.querySelector('.flour-name').value.trim(),
    grams: parseFloat(row.querySelector('.flour-grams').value)||0,
  })).filter(f => f.flour_name);

  const id = document.getElementById('bread-id').value;
  let breadId = id;
  if (id) {
    await sb.from('breads').update(payload).eq('id', id);
    await sb.from('bread_flours').delete().eq('bread_id', id);
  } else {
    const { data } = await sb.from('breads').insert(payload).select().single();
    breadId = data.id;
  }
  if (flours.length) {
    await sb.from('bread_flours').insert(flours.map(f => ({ ...f, bread_id: breadId })));
  }
  closePanel('bread-panel');
  toast('Bake saved!');
  loadBreads();
}

async function deleteBread() {
  if (!confirm('Delete this bake record?')) return;
  const id = document.getElementById('bread-id').value;
  await sb.from('breads').delete().eq('id', id);
  closePanel('bread-panel');
  toast('Bake deleted.');
  loadBreads();
}

// ─── HOW MUCH ───────────────────────────────────────────────────────────────
let allHM = [];

async function loadHM() {
  const { data } = await sb.from('how_much').select('*').order('item');
  allHM = data || [];
  renderHM();
}

function renderHM() {
  const tbody = document.getElementById('hm-body');
  if (!allHM.length) { tbody.innerHTML = '<tr><td colspan="3" class="empty">Nothing here yet.</td></tr>'; return; }
  tbody.innerHTML = allHM.map(h => `
    <tr style="cursor:pointer" onclick="openHMPanel(${JSON.stringify(h).replace(/"/g,'&quot;')})">
      <td><strong>${h.item}</strong></td>
      <td>${h.quantity_note||''}</td>
      <td style="text-align:right"><button class="btn-danger" onclick="event.stopPropagation();deleteHMById('${h.id}')">×</button></td>
    </tr>
  `).join('');
}

function openHMPanel(hm) {
  document.getElementById('hm-id').value = hm ? hm.id : '';
  document.getElementById('hm-item').value = hm ? hm.item : '';
  document.getElementById('hm-qty').value = hm ? (hm.quantity_note||'') : '';
  document.getElementById('hm-delete-btn').style.display = hm ? 'inline-flex' : 'none';
  document.getElementById('hm-panel').classList.add('open');
}

async function saveHM() {
  const item = document.getElementById('hm-item').value.trim();
  if (!item) { toast('Please enter an item'); return; }
  const payload = { item, quantity_note: document.getElementById('hm-qty').value.trim() };
  const id = document.getElementById('hm-id').value;
  if (id) {
    await sb.from('how_much').update({ ...payload, updated_at: new Date().toISOString() }).eq('id', id);
  } else {
    await sb.from('how_much').insert(payload);
  }
  closePanel('hm-panel');
  toast('Saved!');
  loadHM();
}

async function deleteHM() {
  const id = document.getElementById('hm-id').value;
  await deleteHMById(id);
  closePanel('hm-panel');
}

async function deleteHMById(id) {
  await sb.from('how_much').delete().eq('id', id);
  toast('Deleted.');
  loadHM();
}

// ─── MENU PLANNER ───────────────────────────────────────────────────────────
let menuYear, menuMonth, menuData = {};
const ACTIVE_DAYS = [0, 1, 3]; // Mon=0, Tue=1, Thu=3

function initMenu() {
  const now = new Date();
  menuYear = now.getFullYear();
  menuMonth = now.getMonth();
  renderCalendar();
}

function changeMonth(delta) {
  menuMonth += delta;
  if (menuMonth > 11) { menuMonth = 0; menuYear++; }
  if (menuMonth < 0) { menuMonth = 11; menuYear--; }
  renderCalendar();
}

async function renderCalendar() {
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('month-label').textContent = `${months[menuMonth]} ${menuYear}`;

  // Load menu data for this month
  const startDate = `${menuYear}-${String(menuMonth+1).padStart(2,'0')}-01`;
  const endDate = `${menuYear}-${String(menuMonth+1).padStart(2,'0')}-31`;
  const { data } = await sb.from('menus').select('*').gte('date', startDate).lte('date', endDate);
  menuData = {};
  (data||[]).forEach(m => {
    if (!menuData[m.date]) menuData[m.date] = {};
    menuData[m.date][m.meal_type] = m.description;
  });

  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';

  const firstDay = new Date(menuYear, menuMonth, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(menuYear, menuMonth + 1, 0).getDate();
  // Convert to Mon-start: Sun=6, Mon=0, Tue=1...
  const startOffset = (firstDay + 6) % 7;

  let cells = [];
  for (let i = 0; i < startOffset; i++) cells.push(null);
  for (let d = 1; d <= daysInMonth; d++) cells.push(d);
  while (cells.length % 7 !== 0) cells.push(null);

  for (let w = 0; w < cells.length / 7; w++) {
    const row = document.createElement('div');
    row.className = 'week-row';
    for (let d = 0; d < 7; d++) {
      const day = cells[w*7+d];
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      const dayOfWeek = d; // 0=Mon,1=Tue,...,6=Sun
      const isActive = ACTIVE_DAYS.includes(dayOfWeek);
      if (!day || !isActive) cell.classList.add('inactive');

      if (day) {
        const dateStr = `${menuYear}-${String(menuMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const bfast = menuData[dateStr] && menuData[dateStr]['breakfast'];
        const lunch = menuData[dateStr] && menuData[dateStr]['lunch'];
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${isActive ? `<div class="day-name">${dayNames[d]}</div>` : ''}
          ${bfast ? `<div class="meal-label">Breakfast</div><div class="meal-preview">${bfast.substring(0,60)}${bfast.length>60?'…':''}</div>` : ''}
          ${lunch ? `<div class="meal-label" style="margin-top:4px">Lunch</div><div class="meal-preview">${lunch.substring(0,60)}${lunch.length>60?'…':''}</div>` : ''}
        `;
        if (isActive) {
          cell.onclick = () => openMenuPanel(dateStr, dayNames[d] + ' ' + day);
        }
      }
      row.appendChild(cell);
    }
    grid.appendChild(row);
  }
}

function openMenuPanel(dateStr, label) {
  document.getElementById('menu-panel-title').textContent = label;
  document.getElementById('menu-date').value = dateStr;
  document.getElementById('menu-breakfast').value = (menuData[dateStr] && menuData[dateStr]['breakfast']) || '';
  document.getElementById('menu-lunch').value = (menuData[dateStr] && menuData[dateStr]['lunch']) || '';
  document.getElementById('menu-panel').classList.add('open');
}

async function saveMenu() {
  const date = document.getElementById('menu-date').value;
  const breakfast = document.getElementById('menu-breakfast').value.trim();
  const lunch = document.getElementById('menu-lunch').value.trim();

  const upserts = [];
  if (breakfast !== undefined) upserts.push({ date, meal_type: 'breakfast', description: breakfast });
  if (lunch !== undefined) upserts.push({ date, meal_type: 'lunch', description: lunch });

  await sb.from('menus').upsert(upserts, { onConflict: 'date,meal_type' });
  closePanel('menu-panel');
  toast('Menu saved!');
  renderCalendar();
}

// ─── INIT ───────────────────────────────────────────────────────────────────
loadRecipes();
initMenu();
</script>
</body>
</html>
